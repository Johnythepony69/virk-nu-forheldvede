{% extends "base.html" %}

{% block title %}Leder - Minikasse System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Inventory Management -->
        <div class="card card-custom mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-warehouse me-2"></i>Lagerstyring
                </h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th><i class="fas fa-box me-1"></i>Vare</th>
                                <th><i class="fas fa-dollar-sign me-1"></i>Pris</th>
                                <th><i class="fas fa-cubes me-1"></i>Lager</th>
                                <th><i class="fas fa-shopping-cart me-1"></i>Solgt</th>
                                <th><i class="fas fa-chart-line me-1"></i>Omsætning</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item, info in inventory.items() %}
                            <tr>
                                <td class="fw-bold">{{ item }}</td>
                                <td><span class="badge bg-primary rounded-pill">{{ info.price }} kr</span></td>
                                <td>
                                    {% if info.stock > 10 %}
                                    <span class="badge bg-success rounded-pill">{{ info.stock }}</span>
                                    {% elif info.stock > 0 %}
                                    <span class="badge bg-warning rounded-pill">{{ info.stock }}</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill">{{ info.stock }}</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-info rounded-pill">{{ info.sold }}</span></td>
                                <td><span class="badge bg-success rounded-pill">{{ info.sold * info.price }} kr</span></td>
                                <td>
                                    {% if info.stock > 10 %}
                                    <i class="fas fa-check-circle text-success" title="God beholdning"></i>
                                    {% elif info.stock > 0 %}
                                    <i class="fas fa-exclamation-triangle text-warning" title="Lav beholdning"></i>
                                    {% else %}
                                    <i class="fas fa-times-circle text-danger" title="Udsolgt - genbestil!"></i>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="card card-custom">
            <div class="card-header bg-success text-white">
                <h4 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Omsætningsfordeling
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="profitChart" height="300"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h2 class="text-success fw-bold">{{ profit }} kr</h2>
                                <p class="text-muted mb-0">Total Profit</p>
                                <hr>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Baseret på alle salg
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Add New Item -->
        <div class="card card-custom mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Tilføj Ny Vare
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('add_item') }}">
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-tag me-2"></i>Varenavn
                        </label>
                        <input type="text" name="item" class="form-control form-control-custom" placeholder="F.eks. Coca Cola" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-dollar-sign me-2"></i>Pris (kr)
                        </label>
                        <input type="number" name="price" class="form-control form-control-custom" placeholder="F.eks. 15" min="1" step="0.01" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-cubes me-2"></i>Antal på lager
                        </label>
                        <input type="number" name="stock" class="form-control form-control-custom" placeholder="F.eks. 50" min="0" required>
                    </div>
                    
                    <button type="submit" class="btn btn-success-custom btn-custom w-100">
                        <i class="fas fa-plus me-2"></i>Tilføj Vare
                    </button>
                </form>
            </div>
        </div>

        <!-- User Management -->
        <div class="card card-custom mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-users me-2"></i>Brugerhåndtering
                </h5>
            </div>
            <div class="card-body text-center">
                <p class="card-text">Administrer brugere og adgangskoder</p>
                <a href="{{ url_for('manage_users') }}" class="btn btn-primary-custom btn-custom w-100">
                    <i class="fas fa-key me-2"></i>Håndter Brugere
                </a>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="card card-custom mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Hurtig Oversigt
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <h4 class="text-primary">{{ inventory|length }}</h4>
                        <small class="text-muted">Produkter</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ inventory.values()|sum(attribute='sold') }}</h4>
                        <small class="text-muted">Solgte Varer</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6 border-end">
                        <h4 class="text-warning">{{ inventory.values()|sum(attribute='stock') }}</h4>
                        <small class="text-muted">Total Lager</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-danger">{{ (inventory.values()|selectattr('stock', 'eq', 0)|list)|length }}</h4>
                        <small class="text-muted">Udsolgt</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div class="card card-custom">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Advarsler
                </h5>
            </div>
            <div class="card-body">
                {% set low_stock_items = inventory.items()|selectattr('1.stock', 'le', 5)|list %}
                {% if low_stock_items %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Lav beholdning:</strong>
                    <ul class="mb-0 mt-2">
                        {% for item, info in low_stock_items %}
                        <li>{{ item }}: {{ info.stock }} stk tilbage</li>
                        {% endfor %}
                    </ul>
                </div>
                {% else %}
                <div class="alert alert-success" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    Alle varer har tilstrækkelig beholdning
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
fetch("{{ url_for('profit_data') }}").then(r => r.json()).then(data => {
    const ctx = document.getElementById("profitChart").getContext("2d");
    
    const colors = [
        'rgba(255, 99, 132, 0.8)',
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 159, 64, 0.8)',
        'rgba(199, 199, 199, 0.8)',
        'rgba(83, 102, 255, 0.8)'
    ];
    
    new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: data.chart.map(x => x.item),
            datasets: [{
                data: data.chart.map(x => x.revenue),
                backgroundColor: colors.slice(0, data.chart.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return label + ': ' + value + ' kr (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
